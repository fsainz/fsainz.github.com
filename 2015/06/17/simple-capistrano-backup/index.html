<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Fernando Sainz personal blog">

    <title>Simple Capistrano Backup - fsainz</title>

    <link rel="canonical" href="http://www.fsainz.com/2015/06/17/simple-capistrano-backup/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <link rel="stylesheet" href="../css/lightgallery.min.css" />
    <link rel="stylesheet" href="../css/lg-transitions.min.css" />
    <link rel="stylesheet" href="../css/lightgallery-custom.css" />

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button
        type="button"
        class="navbar-toggle"
        data-toggle="collapse"
        data-target="#bs-example-navbar-collapse-1"
      >
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">fsainz</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/">Home</a>
        </li>
        
        <li>
          <a href="/about/">About</a>
        </li>
        
        <li>
          <a href="/projects/">projects</a>
        </li>
        
        <li>
          <a href="//www.fsainz.com/bonn">Bonn</a>
        </li>
      </ul>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h1 id="simple-capistrano-backup">Simple Capistrano Backup</h1>

<p class="meta">June 17th, 2015 - Bonn</p>

<p>I wanted to have a dead simple script to create a backup of the files and the database on the deployer home folder with a capistrano task.
It could use some refactor, and it could be made more flexible in many aspects, but it works and it’s just a small bunch of lines.</p>

<p>There are good backup libraries that you let you encrypt, split, upload to multiple places and be notified whether has been a problem or not. They also take care of automating the restoring process, and let you switch between different versions and remove old backups. Setting that up takes more time though, this script is only valid for simple situations, it doesn’t compare to those libraries but it sure beats not having any script at all.</p>

<p>I added explicitely the <code>PGPASSWORD</code> to the dump command, but there are better ways, you can add a <code>.pgpass</code> file to your home folder, and add a <code>--no-password</code> flag (more info <a href="http://www.postgresql.org/docs/current/static/libpq-pgpass.html">here</a>). You can also add it as an <a href="http://www.postgresql.org/docs/current/static/libpq-pgpass.html">environment variable</a></p>

<p>Another improvement is to make it run periodically using a cron job: <a href="http://www.gotealeaf.com/blog/cron-jobs-and-rails">cron-jobs-and-rails</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/capistrano/tasks/simple_backup.rake</span>

<span class="n">set</span> <span class="ss">:database_staging</span><span class="p">,</span>    <span class="s2">"database_staging"</span>
<span class="n">set</span> <span class="ss">:database_production</span><span class="p">,</span> <span class="s2">"database_production"</span>
<span class="c1"># IMPORTANT -&gt; put a path to the folder, not the symlink, like "../shared/public/uploads"</span>
<span class="n">set</span> <span class="ss">:files_to_backup_relative_path</span><span class="p">,</span> <span class="s2">"../shared/public/uploads"</span>

<span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>

  <span class="n">desc</span> <span class="s2">"Dump the DB and tar the uploads to the deployer home"</span>
  <span class="n">task</span> <span class="ss">:simple_backup</span> <span class="k">do</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:stage</span><span class="p">)</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="s2">"database_</span><span class="si">#{</span><span class="n">stage</span><span class="si">}</span><span class="s2">"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>
    <span class="k">raise</span> <span class="s2">"Missing database name"</span> <span class="k">unless</span> <span class="n">database</span>

    <span class="n">scp_commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_stamp</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s2">"%F-%H-%M-%S"</span><span class="p">)</span>
    <span class="n">database_dump_name</span> <span class="o">=</span> <span class="s2">"dump_</span><span class="si">#{</span><span class="n">database</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">database_dump_cmd</span> <span class="o">=</span> <span class="s2">"PGPASSWORD=********* pg_dump </span><span class="si">#{</span><span class="n">database</span><span class="si">}</span><span class="s2"> -U postgres -h localhost &gt; </span><span class="si">#{</span><span class="n">database_dump_name</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">perform_files_backup</span> <span class="o">=</span> <span class="o">!!</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:files_to_backup_relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">perform_files_backup</span>
      <span class="n">files_path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">release_path</span><span class="p">,</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:files_to_backup_relative_path</span><span class="p">)))</span>
      <span class="n">files_parent_path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s2">"../"</span><span class="p">,</span> <span class="n">files_path</span><span class="p">)</span>
      <span class="n">files_path_basedir</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">files_path</span><span class="p">)</span>
      <span class="n">files_backup_name</span> <span class="o">=</span> <span class="s2">"files_</span><span class="si">#{</span><span class="n">stage</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s2">.tar.gz"</span>
    <span class="k">end</span>

    <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2"> ### STARTING BACKUP ON </span><span class="si">#{</span><span class="n">stage</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2"> AT </span><span class="si">#{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s2">"</span>

    <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2"> ### DUMPING THE DATABASE"</span>
      <span class="n">scp_base_cmd</span> <span class="o">=</span> <span class="s2">"scp </span><span class="si">#{</span><span class="n">server</span><span class="p">.</span><span class="nf">user</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="n">server</span><span class="p">.</span><span class="nf">hostname</span><span class="si">}</span><span class="s2">:~/"</span>
      <span class="n">execute</span> <span class="n">database_dump_cmd</span>
      <span class="n">scp_commands</span> <span class="o">&lt;&lt;</span> <span class="n">scp_base_cmd</span> <span class="o">+</span> <span class="n">database_dump_name</span> <span class="o">+</span> <span class="s2">" ."</span>

      <span class="k">if</span> <span class="n">perform_files_backup</span>
        <span class="n">files_compression_cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_compression_cmds</span> <span class="o">&lt;&lt;</span> <span class="s2">"cd </span><span class="si">#{</span><span class="n">files_parent_path</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">files_compression_cmds</span> <span class="o">&lt;&lt;</span> <span class="s2">"tar zczf </span><span class="si">#{</span><span class="n">files_backup_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">files_path_basedir</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">files_compression_cmds</span> <span class="o">&lt;&lt;</span> <span class="s2">"mv </span><span class="si">#{</span><span class="n">files_backup_name</span><span class="si">}</span><span class="s2"> ~"</span>
        <span class="n">files_compression_cmd</span> <span class="o">=</span> <span class="n">files_compression_cmds</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">" &amp;&amp; "</span><span class="p">)</span>

        <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2"> ### COMPRESSING FILES AT </span><span class="si">#{</span><span class="n">files_path</span><span class="si">}</span><span class="s2">"</span>
        <span class="nb">puts</span> <span class="n">files_compression_cmd</span>
        <span class="n">execute</span> <span class="n">files_compression_cmd</span>
        <span class="n">scp_commands</span> <span class="o">&lt;&lt;</span> <span class="n">scp_base_cmd</span> <span class="o">+</span> <span class="n">files_backup_name</span> <span class="o">+</span> <span class="s2">" ."</span>
      <span class="k">end</span>

      <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2"> GET THE FILES WITH:</span><span class="se">\n</span><span class="s2">"</span>
      <span class="n">scp_commands</span><span class="p">.</span><span class="nf">each</span><span class="p">{</span><span class="o">|</span><span class="n">cmd</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">cmd</span><span class="p">}</span>
      <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p>After executing it, you get the lines needed to download the files</p>

<p><code class="language-plaintext highlighter-rouge">bundle exec cap staging deploy:simple_backup</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp deployer@[IP]:~/files_production_2015-06-16-15-33-28.tar.gz .
scp deployer@[IP]:~/dump_database_production_2015-06-16-15-33-28 .
</code></pre></div></div>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/06/08/files-on-electron/" data-toggle="tooltip" data-placement="top" title="Uploading files with Electron">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2015/09/13/sass-at-root/" data-toggle="tooltip" data-placement="top" title="Sass @at-root">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/fsainz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://codepen.io/fsainz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-codepen fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://speakerdeck.com/fsainz/">
                          <span class="fa-stack fa-lg">
                            <svg width="50px" height="50px" viewBox="0 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                                <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
                                    <path d="M256,512 C397.384903,512 512,397.384903 512,256 C512,114.615097 397.384903,0 256,0 C114.615097,0 0,114.615097 0,256 C0,397.384903 114.615097,512 256,512 Z M157.00292,151 C136.014487,151 119,168.007298 119,188.999 L119,323.001 C119,343.987268 136.020832,361 157.00292,361 L355.99708,361 C376.985513,361 394,343.992702 394,323.001 L394,188.999 C394,168.012732 376.979168,151 355.99708,151 L157.00292,151 Z M213.327471,218.914007 C201.732729,218.914007 192.333333,228.319857 192.333333,239.90541 L192.333333,272.040251 C192.333333,283.633483 201.743977,293.031654 213.327471,293.031654 L299.672529,293.031654 C311.267271,293.031654 320.666667,283.625804 320.666667,272.040251 L320.666667,239.90541 C320.666667,228.312179 311.256023,218.914007 299.672529,218.914007 L213.327471,218.914007 Z M210.470588,255.972831 L247.529412,237.639497 L247.529412,274.306164 L210.470588,255.972831 Z M264.279134,274.502243 L264.279134,237.443419 L300.945801,255.972831 L264.279134,274.502243 Z" id="sliderdeck" fill="#404040" sketch:type="MSShapeGroup"></path>
                                </g>
                            </svg>
                          </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://fsainz.tumblr.com/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-tumblr fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://de.linkedin.com/in/fernandosainz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="mailto:info@fsainz.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                  Copyright &copy; fsainz 2026
                  <br />
                  Theme adapted from <a class='text-muted' href="https://github.com/IronSummitMedia/startbootstrap-clean-blog-jekyll">startbootstrap-clean-blog-jekyll</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

<script src="../js/lightgallery-all.min.js"></script>

<script>
  
</script>


</body>

</html>
