<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Fernando Sainz personal blog">

    <title>Rails https and non-standard ports in vagrant - fsainz</title>

    <link rel="canonical" href="http://www.fsainz.com/2012/10/21/rails-https-and-non-standard-ports-in-vagrant/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <link rel="stylesheet" href="../css/lightgallery.min.css" />
    <link rel="stylesheet" href="../css/lg-transitions.min.css" />
    <link rel="stylesheet" href="../css/lightgallery-custom.css" />

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button
        type="button"
        class="navbar-toggle"
        data-toggle="collapse"
        data-target="#bs-example-navbar-collapse-1"
      >
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">fsainz</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/">Home</a>
        </li>
        
        <li>
          <a href="/about/">About</a>
        </li>
        
        <li>
          <a href="/projects/">projects</a>
        </li>
        
        <li>
          <a href="//www.fsainz.com/bonn">Bonn</a>
        </li>
      </ul>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h1 id="rails-https-and-non-standard-ports-in-vagrant">Rails https and non-standard ports in vagrant</h1>

<p class="meta">October 21th, 2012 - Madrid</p>

<p>Our way of dealing with http and https requests from a vagrant machine
was to forward from the guest machine to some higher ports such as 8080
and 8433 and then add some rules to the Mac OSX built-in firewall to
bind 80 to 8080 and 443 to 8443 on the host machine. Thus, the links and
redirects generated by our rails app didn’t need to know anything about the ports
that we were using to connect from our outside world.</p>

<p>We decided that we wanted to have as many machines and services
running simultaneously as we wanted without having to worry about
conflicting ports, so we adopted another strategy in which we specify
the forwarded ports in a configuration file in our rails app, and we
take care of them as transparently as possible.</p>

<p>We also wanted rails to generate the proper urls for multiple domains,
so we set a <em>host</em> header in our nginx directives along with the
<em> X-Forwarded-Proto $scheme</em> that lets rails know that it’s
dealing with a http or https request.</p>

<h1 id="in-our-nginx-server">in our nginx server:</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location / {
    proxy_pass  http://local_3000;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
}
</code></pre></div></div>

<p>To let our app know which are the ports we are using, we set them in a
application.yml file. This file is ignored in our repo so each developer
can set their own ports.</p>

<h1 id="configapplicationyml">config/application.yml</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>development:
  http_port: 8080 #leave null for 80
  https_port: 8443 #leave null for 443
test:
  http_port: null #leave null for 80
  https_port: null #leave null for 443
production:
  http_port: 9080 #leave null for 80
  https_port: 9443 #leave null for 443
</code></pre></div></div>

<p>We load this settings in our application.rb they way that Ryan proposes
in this <a href="http://railscasts.com/episodes/85-yaml-configuration-revised">railscast</a></p>

<h1 id="configapplicationrb">config/application.rb</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> CONFIG = YAML.load(File.read(File.expand_path('../application.yml', __FILE__)))
 CONFIG.merge! CONFIG.fetch(Rails.env, {})
 CONFIG.symbolize_keys!
</code></pre></div></div>

<p>Instead of using Rails.application.routes.default_url_options, we define
a method in our ApplicationController in order to have different
defaults depending on the current request scheme.</p>

<h1 id="appcontrollersapplication_controllerrb">app/controllers/application_controller.rb</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def default_url_options(options={})
   port = request.ssl? ? CONFIG[:https_port] : CONFIG[:http_port]
   options = { :port=&gt; port }
   options
 end

 def default_host_with_port
   "#{url_options[:host]}#{":#{url_options[:port]}" if url_options[:port]}"
 end

helper_method :default_url_options, :default_host_with_port
</code></pre></div></div>

<p>the first method gives proper defaults for url routes when the kind of
request is preserved, when we want to change for example from a https
request to http we need to be specific:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> my_route_url(:protocol =&gt; 'http', :port=&gt;CONFIG[:http_port])
</code></pre></div></div>

<p>the helper <code>default_host_with_port</code> replaces the <code>request.host_with_port</code> that we were using to specify the path to some assets:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  image_tag("//#{default_host_with_port}/path_to_image")
</code></pre></div></div>

<p>The trickiest part was to take care of the redirects. It was unclear for
us how rails was filling in the remaining part of the url every time we
used a <em>redirect_to</em> to a path instead of a url, and worst of
all, we couldn’t easily change the way other gems handled their redirects,
specially when devise relied on warden to handle the response.</p>

<p>Fortunately, we could take advantage of the middleware to detect if
we were performing a redirect to another location in our server
and set the proper port before letting the response leave our app.</p>

<h1 id="appmiddlewateset_special_portsrb">app/middlewate/set_special_ports.rb</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class SetSpecialPorts
  def initialize(app)
    @app = app
  end

  def call(env)

   server_name = env["SERVER_NAME"]

    # execute the request using our Rails app
   status, headers, body = @app.call(env)

    if internal_redirect?(status, headers, server_name)
      [status, {"Location" =&gt; url_with_port(headers["Location"])}, ['Redirecting you to the new location...']]
    else
    # just send the response as it is
      [status, headers, body]
    end
  end

  def internal_redirect?(status, headers, server_name)
    uri = URI.parse(headers["Location"]) if headers["Location"]
    [300, 301, 302, 307].include?(status) &amp;&amp; uri.try(:host) == server_name
  end

  # add the ports for http and https defined in our CONFIG settings through application.yml
  def url_with_port(url)
    uri = URI.parse(url)
    uri.port = CONFIG["#{uri.scheme}_port".to_sym]
    uri.to_s
  end

end
</code></pre></div></div>

<p><br /></p>
<h1 id="configapplicationrb-1">config/application.rb</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config.middleware.insert_before "Warden::Manager", "SetSpecialPorts"
</code></pre></div></div>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2012/09/16/vagrant-issues/" data-toggle="tooltip" data-placement="top" title="Vagrant Issues">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2012/12/21/2012-improvements/" data-toggle="tooltip" data-placement="top" title="2012 Improvements">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/fsainz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://codepen.io/fsainz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-codepen fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://speakerdeck.com/fsainz/">
                          <span class="fa-stack fa-lg">
                            <svg width="50px" height="50px" viewBox="0 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                                <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
                                    <path d="M256,512 C397.384903,512 512,397.384903 512,256 C512,114.615097 397.384903,0 256,0 C114.615097,0 0,114.615097 0,256 C0,397.384903 114.615097,512 256,512 Z M157.00292,151 C136.014487,151 119,168.007298 119,188.999 L119,323.001 C119,343.987268 136.020832,361 157.00292,361 L355.99708,361 C376.985513,361 394,343.992702 394,323.001 L394,188.999 C394,168.012732 376.979168,151 355.99708,151 L157.00292,151 Z M213.327471,218.914007 C201.732729,218.914007 192.333333,228.319857 192.333333,239.90541 L192.333333,272.040251 C192.333333,283.633483 201.743977,293.031654 213.327471,293.031654 L299.672529,293.031654 C311.267271,293.031654 320.666667,283.625804 320.666667,272.040251 L320.666667,239.90541 C320.666667,228.312179 311.256023,218.914007 299.672529,218.914007 L213.327471,218.914007 Z M210.470588,255.972831 L247.529412,237.639497 L247.529412,274.306164 L210.470588,255.972831 Z M264.279134,274.502243 L264.279134,237.443419 L300.945801,255.972831 L264.279134,274.502243 Z" id="sliderdeck" fill="#404040" sketch:type="MSShapeGroup"></path>
                                </g>
                            </svg>
                          </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://fsainz.tumblr.com/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-tumblr fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://de.linkedin.com/in/fernandosainz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="mailto:info@fsainz.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                  Copyright &copy; fsainz 2026
                  <br />
                  Theme adapted from <a class='text-muted' href="https://github.com/IronSummitMedia/startbootstrap-clean-blog-jekyll">startbootstrap-clean-blog-jekyll</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

<script src="../js/lightgallery-all.min.js"></script>

<script>
  
</script>


</body>

</html>
